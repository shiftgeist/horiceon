#!/usr/bin/env bash

set -e

# shows count of upgradable apt packages
# xfce genmon docs: https://docs.xfce.org/panel-plugins/xfce4-genmon-plugin/start

print_airwater() {
  if ! curl -s cht.sh &>/dev/null; then # check network
    echo -e "Disconnected ðŸŒŠ"
    return
  fi

  # config
  config="$XDG_CONFIG_HOME/chezmoi/chezmoi.yaml"
  url=$(yq -p=yaml ".data.api.airwater_url" <"$config")
  dataout="$HOME/cloud/second-brain/data/forecast.yaml"
  date=$(date --iso-8601=hours)

  if [ ! -f "$dataout" ]; then
    touch "$dataout"
  else
    airwater=$(yq -p=yaml ".[\"$date\"]" <"$dataout")
  fi

  wttrin=$(curl -s -L "https://wttr.in/?format=j1")
  condition=$(echo "$wttrin" | jq '.current_condition[0].weatherDesc[0].value' | sed -r "s/\"//g")
  yq -i ".[\"$date\"].condition = \"$condition\"" "$dataout"

  if [ "$airwater" = "null" ]; then
    airwater=$(curl -s -L "$url" | yq -p=xml ".WXDATA.PARAM")

    # cache saving
    yq -i ".[\"$date\"] = (\"$airwater\" | from_yaml)" "$dataout"
  fi

  # data handling
  airtemp="$(echo "$airwater" | yq -p=yaml '.airtemp' | awk '{print int($1+0.5)}')"
  watertemp="$(echo "$airwater" | yq -p=yaml '.watertemp' | awk '{print int($1+0.5)}')"

  # output values to bar
  echo -e "<txt>${condition} ${airtemp}Â°C ðŸŒŠ ${watertemp}Â°C</txt>"
  echo -e "<txtclick>xdg-open https://wttr.in</txtclick>"
}

main() {
  print_airwater
}

main
